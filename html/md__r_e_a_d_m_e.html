<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: README</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">README </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Antoine PLANTIER LP SIGD IOTIA </p>
<h2><a class="anchor" id="autotoc_md1"></a>
Module Objets Conectés</h2>
<h1><a class="anchor" id="autotoc_md2"></a>
Projet d'Objets Conectés : Réseau de capteurs Communication LoRa</h1>
<h2><a class="anchor" id="autotoc_md3"></a>
Introduction</h2>
<h3><a class="anchor" id="autotoc_md4"></a>
Résumé</h3>
<p>Dans le cadre du Module d'objets conectés, nous avions a faire un projet metant en oeuvre le protocole de communication <b>LoRa</b>. J'ai choisis de mettre en place un réseau de communication assurant un relevé de mesures et leurs utilisations dans un programe python.</p>
<p>Le projet consiste en un noeud collecteur _(Rx/receviver)_ qui receptionne les données envoyées par différents noeuds emeteurs _(Tx/sender)_. Ces données sont traitées et stoquées par un programme en python. Celui ci offre différentes actions de traitement et d'interactions.</p>
<h3><a class="anchor" id="autotoc_md5"></a>
Materiel</h3>
<p>Pour ce projet nous travaillons avec des arduino intégrant des modules <b>LoRa</b></p>
<p><a href="https://github.com/FabienFerrero/UCA_Board">Cf Page Web du module</a></p><ul>
<li>Les Modules Arduino utilisés <a href="https://www.arduino.cc/en/uploads/Main/Arduino-Pro-Mini-schematic.pdf">https://www.arduino.cc/en/uploads/Main/Arduino-Pro-Mini-schematic.pdf</a> <a href="https://cdn.sparkfun.com/assets/c/6/2/2/1/ProMini8MHzv2.pdf">https://cdn.sparkfun.com/assets/c/6/2/2/1/ProMini8MHzv2.pdf</a></li>
</ul>
<p>Nous utilison également des capteurs :</p>
<ul>
<li>ky-015 temperature &amp; humidite</li>
</ul>
<p><a href="https://tkkrlab.nl/wiki/Arduino_KY-015_Temperature_and_humidity_sensor_module">https://tkkrlab.nl/wiki/Arduino_KY-015_Temperature_and_humidity_sensor_module</a> <a href="https://arduinomodules.info/ky-015-temperature-humidity-sensor-module/">https://arduinomodules.info/ky-015-temperature-humidity-sensor-module/</a></p>
<ul>
<li>ky-026 detecteur de flamme</li>
</ul>
<p>Voltage : 3.3 - 5.5V Spectre infrarouge détecté : 760 nm to 1100 nm</p>
<p><a href="https://arduinomodules.info/ky-026-flame-sensor-module/">https://arduinomodules.info/ky-026-flame-sensor-module/</a> <a href="https://www.thegeekpub.com/wiki/sensor-wiki-ky-026-flame-ir-sensor/">https://www.thegeekpub.com/wiki/sensor-wiki-ky-026-flame-ir-sensor/</a> <a href="https://www.arduinoforbeginners.com/ky-026-arduino-flame-ir-sensor/">https://www.arduinoforbeginners.com/ky-026-arduino-flame-ir-sensor/</a></p>
<h3><a class="anchor" id="autotoc_md6"></a>
Langages</h3>
<ul>
<li>C</li>
<li>Python</li>
<li>SQL</li>
</ul>
<h2><a class="anchor" id="autotoc_md7"></a>
Fonctionnement général</h2>
<p>Le module Recepteur <b>Rx/receiver</b> est conecté par le port série à l'ordinateur sur lequel tourne le programme en python.</p>
<p>Le module recepteur <b><a class="el" href="struct_rx.html" title="Structure représentant un noeud enregistré">Rx</a></b> est en écoute sur un canal du protocol LoRa. Lorsque un module emetteur <b>Tx</b> se connecte sur un canal, il s'authentifie auprès de <b><a class="el" href="struct_rx.html" title="Structure représentant un noeud enregistré">Rx</a></b>, dès lors, il peut lui envoyer les données qu'il collecte avec ses capteurs.</p>
<p>Ces données sont traitées par le software pour pouvoir les exploiter: elles sont datées, structurée et stockées. Le software permet par exemple de voir un graphique de l'évolution de la temperature actualisé dynamiquement, ou encore de faire des calculs : moyenne glissante, moyenne par jours ... etc</p>
<p>Il existe également un mode d'urgence. Si un des modules ky-026 détecte une flamme, une interuption est générée sur le module émetteur qui se met donc en état d'alerte. la fréquence d'envoi des tramme est accéléré pour évaluer le danger, une alarme se met à sonner sur <b>Tx</b> et <b><a class="el" href="struct_rx.html" title="Structure représentant un noeud enregistré">Rx</a></b> et un email est envoyé pour avertir du dangers.</p>
<p>Voici le schéma général du projet.</p>
<p><img src="/src/schem_General.png" alt="Projet Général" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md8"></a>
Configuration LoRa des modules</h2>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">LoRa.begin(915E6); // parametre réseau pour l&#39;europe </div>
<div class="line">LoRa.setTxPower(txPo, 1);// puissance d&#39;émission à 20 ; la pin de sortie de l&#39;emeteur</div>
<div class="line">LoRa.setSpreadingFactor(spFa); // le sf ici gardé a 12</div>
<div class="line">LoRa.setSignalBandwidth(baWi);// bande passante du signal 125E3</div>
<div class="line">LoRa.setPreambleLength(prLe); // la longueur du preambules</div>
<div class="line">LoRa.setSyncWord(CANAL);// le canal de communication ici 0xA2</div>
<div class="line">LoRa.enableCrc(); //activation du crc</div>
</div><!-- fragment --><p>Pins utilisés par le module LoRa</p>
<div class="fragment"><div class="line">ATMega328p       LoRa RFM95W </div>
<div class="line">                   Module</div>
<div class="line"> D8          &lt;----&gt; RST</div>
<div class="line"> MISO  (D12) &lt;----&gt; MISO</div>
<div class="line"> MOSI  (D11) &lt;----&gt; MOSI</div>
<div class="line"> SCK   (D13) &lt;----&gt; CLK</div>
<div class="line"> SS    (D10) &lt;----&gt; SEL (Chip Select)</div>
<div class="line"> D3          &lt;----&gt; DIO0</div>
<div class="line"> D7          &lt;----&gt; DIO1</div>
<div class="line"> D6          &lt;----&gt; DIO2</div>
<div class="line"> 3.3V        &lt;----&gt; Vcc</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md9"></a>
Les modules Emeteurs : Sender/ TX</h2>
<h3><a class="anchor" id="autotoc_md10"></a>
Les pins utilisées pour les capteurs :</h3>
<div class="fragment"><div class="line">ATMega328p       Capteurs</div>
<div class="line"> </div>
<div class="line">                   Ky-026(flamme)</div>
<div class="line"> A0          &lt;----&gt; entrée analogique ( Out [0;1024] )</div>
<div class="line"> 2(D2)       &lt;----&gt; entrée Digitale ( etat haut quand flamme détectée )</div>
<div class="line">                 |     vecteur 1 </div>
<div class="line">                 |_&gt;   ! _ INTERUPTION SUR LE pASSAGE A L&#39;ETAT HAUT _ ! </div>
<div class="line"> </div>
<div class="line">                   Ky-015(Temperature &amp; humidite)</div>
<div class="line"> 5(D5)      &lt;----&gt; entrée Digitale ( envoie une tramme de 5 byte donnat                 les mesures + checksum ) </div>
<div class="line"> </div>
<div class="line">                    Ky-06(Buzzer)</div>
<div class="line">A1          &lt;----&gt; Sortie Analogique </div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md11"></a>
Les variables</h3>
<div class="fragment"><div class="line">// ** Variables globales </div>
<div class="line">static int i_periode = 5000; // Temps du cycle </div>
<div class="line">static int i_AlertePeriode = 500; // Temps du cycle en periode d&#39;alerte</div>
<div class="line">static bool b_Alerte = false; // Detection du feu : true </div>
<div class="line">byte humTmp[5]; // tableau de stockage des mesures Humidite &amp; temperature</div>
<div class="line">byte idTx; //identifiant de l&#39;appareil s&#39;il nest pas enregistré dans tx =0 </div>
<div class="line">byte randNumber; // variable pour stocker une clée générrée aléatoirement avec random() </div>
<div class="line">#define FRAMESIZE 10 // taille de la framme </div>
<div class="line">byte buffer[FRAMESIZE] = { // buffer de communication pour les données</div>
<div class="line">  0</div>
<div class="line">};</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md12"></a>
les trammes</h3>
<p><b>Tx</b> envoie deux types de trammes, chaques trammes a une taille fixe de 10 bytes lorsque ces trammes seront envoyées via le protocole LoRa, chaque bytes de ces trammes seront séparés par un bytes contenant **";"** en guise de séparateur de données.</p>
<p>Attention, les donnée son envoyées Bytes après Bytes par le protocole LoRa mais un chiffre a plusieurs unités n'est pas encodé sur un seul byte.</p>
<p>Ex: 123, devient 1, 2 , 3.</p>
<p>De plus un nombre négatif est casté avec un décalage</p>
<p>Ex : -11 devient 245( 256 - 11 ) et donc 2, 4, 5</p>
<h4><a class="anchor" id="autotoc_md13"></a>
Tramme de mesures</h4>
<p>Parlons en détail de <b>buffer</b> et <b>FRAMESIZE</b> : buffer contient la trame type envoyée via le protocole LoRa et contenant les données mesurées par Tx. Sa taille est fixée (<b>FRAMESIZE</b>) les mesures décimales ont une précision de E-2 fixe.</p>
<p>A savoir que le <b>LoRa</b> transmet les trames bytes après bytes ( non-signés ). Le choix de trame que j'ai choisis est le suivant</p>
<p><img src="/src/tramme.png" alt="Trame" class="inline"/></p>
<ul>
<li><b>IdTx</b> identifiant de l'appareil O quand non identifié</li>
<li><b>Etat</b> Etat de l'appareil (normal/urgence-&gt; feu)</li>
<li><b>erreur</b> Le capteur TempHum peut avoir des ratés cependant les valeures sont soouvent cohérente. J'ai décidé de les garder a chaque fois avec ce code d'erreur qui me permettra de faire un post traitement sur ces données</li>
<li><b>Humidité</b> sur 2 bytes le premier pour la partie entière la seconde pour la partie decimale</li>
<li><b>Température</b> sur 2 bytes le premier pour la partie entière la seconde pour la partie decimale</li>
<li><b>Rayonnement infrarouge</b> en %, plus le seuil est haut plus le rayonnement est fort</li>
<li><b>Checksum</b> somme des valeurs de la tramme dans un byte non signé</li>
<li><b>byte de fin de ligne</b></li>
</ul>
<h4><a class="anchor" id="autotoc_md14"></a>
Tramme d'authentification</h4>
<p>Lorsque l'appareil n'est pas identifié, envoie une trame d'authentification.</p>
<ul>
<li><b>IdTx</b> identifiant de l'appareil O car non identifié. C'est ce qui lancera la procédure d'authentification auprès de <a class="el" href="struct_rx.html" title="Structure représentant un noeud enregistré">Rx</a></li>
<li><b>Key/randNumber</b> byte aléatoire générée avec random(125)</li>
<li><b>Checksum</b> somme des valeurs de la tramme dans un byte non signé</li>
<li><b>byte de fin de ligne</b></li>
</ul>
<p>Le reste des byte est à 0</p>
<h3><a class="anchor" id="autotoc_md15"></a>
Les méthodes</h3>
<h4><a class="anchor" id="autotoc_md16"></a>
void flame_detected()</h4>
<p>Méthode appelée lors d'une <b>interuption sur la pinD2</b>_ . L'etat d'alerte est déclaré <code>bool b_Alerte = true</code></p>
<h4><a class="anchor" id="autotoc_md17"></a>
void buildFrame(bool auth = false)</h4>
<p>Méthode construction des trammes à envoyer. Ces tramme sont construite dans le buffer.</p>
<p>l'argument permet de choisir quelle tramme construire.</p>
<p>Cette fonction appelle les methodes permettant d'efectuer les mesures. (cf <em>humTmp()</em> dans humTmp.h)</p>
<h4><a class="anchor" id="autotoc_md18"></a>
void enregistrementRx()</h4>
<p>Cette methode permet de s'authentifier auprès de <a class="el" href="struct_rx.html" title="Structure représentant un noeud enregistré">Rx</a>. L'algo est le suivant:</p>
<div class="fragment"><div class="line">PRE CONDITIONS : </div>
<div class="line">Pas déja identifié -&gt; idTx=0 </div>
<div class="line">LoRa en mode emission</div>
<div class="line">-----</div>
<div class="line">DEBUT</div>
<div class="line"> </div>
<div class="line">key &lt;-= une clé aléatoire</div>
<div class="line">trame &lt;-= format Trame authentification utilisant key</div>
<div class="line">envoie (trame)</div>
<div class="line"> </div>
<div class="line">passe en mode reception </div>
<div class="line"> </div>
<div class="line">tentative &lt;-= 10 </div>
<div class="line">timeout &lt;-= 250 </div>
<div class="line"> </div>
<div class="line">boucle : tant que le nombre de t&#39;entative &gt;0 AND timeaout !=0 </div>
<div class="line">        SI Frame Recue ET key ==trame recue [1]</div>
<div class="line">            idTx &lt;-= trame recue [2]</div>
<div class="line">            FIN</div>
<div class="line">        SINON tentative -- </div>
<div class="line">    timeout--</div>
<div class="line">AUthentification écouée </div>
<div class="line">FIN</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md19"></a>
void loop()</h3>
<p>La methode loop boucle sur l'arduino.</p>
<p>en pseudo code</p>
<div class="fragment"><div class="line">boucle </div>
<div class="line">    Si Etat d&#39;alerte </div>
<div class="line">        Faire soner l&#39;alarme </div>
<div class="line">        faire tramme d&#39;alerte</div>
<div class="line">        Envoyer Tramme d&#39;alerte</div>
<div class="line">        FIN</div>
<div class="line">    Si appareil pas encore enregistré</div>
<div class="line">        enregistrement()</div>
<div class="line">        FIN</div>
<div class="line">    Mesures des capteurs</div>
<div class="line">    Construction de tramme</div>
<div class="line">    envoi de la trame </div>
<div class="line">    attendre ( laps de temps)</div>
<div class="line">    FIN</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md20"></a>
void Alarme ()</h3>
<p>FOnctions permettant l'emission d'un signal sonore lorsque le module est en état d'alerte. Le buzzer est analogique, on evoie deux tonalités avec deux fréquences.</p>
<h3><a class="anchor" id="autotoc_md21"></a>
void void afficheMesure()</h3>
<p>Fonction d'affichage sur le Serial formaté des dernières mesures sous la forme :mesures </p><div class="fragment"><div class="line">Appareil : 1Etat d&#39;alerte : non---------</div>
<div class="line">Mesures (possibilité d&#39;erreur :non</div>
<div class="line">  |_&gt; Humiditée : 0,0%</div>
<div class="line">  |_&gt; Temperature : 0,0°</div>
<div class="line">  |_&gt; Spectre infrarouge : 18%</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md22"></a>
Le module recepteur : Receiver/ Rx</h2>
<h2><a class="anchor" id="autotoc_md23"></a>
Le fonctions communes à Tx/Rx: envoie &amp; reception de trames</h2>
<h2><a class="anchor" id="autotoc_md24"></a>
Le Software en python</h2>
<h2><a class="anchor" id="autotoc_md25"></a>
liens Utiles</h2>
<h1><a class="anchor" id="autotoc_md26"></a>
TOOOOODOOOOOOOOOOOOOOOOO</h1>
<ul>
<li>Finir redaction</li>
<li>check icrem id register in reeiver</li>
<li>Faire Code python pour récupérer data + qualité transmition</li>
<li>voir pour du sql pour la bdd ?</li>
<li>plot , moyenne glissante, envoie mail</li>
<li>ajouter la posibilité de détecter une alerte incendie même pour un noeud non identifié</li>
<li>compte du nombre de framme recu par chaques Tx + moyenne reception </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
